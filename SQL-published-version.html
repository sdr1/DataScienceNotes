<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">

<head>

<meta charset="utf-8" />
<meta name="generator" content="quarto-1.3.433" />

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />

<meta name="author" content="Steven Rashin" />
<meta name="dcterms.date" content="2024-04-24" />

<title>SQL</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<!-- htmldependencies:E3FAD763 -->

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-full">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <div id="quarto-toc-target"></div>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">SQL</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Steven Rashin </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 24, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>
<nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#preliminaries" id="toc-preliminaries">Preliminaries</a></li>
  <li><a href="#basic-syntax" id="toc-basic-syntax">Basic Syntax</a></li>
  <li><a href="#data-types" id="toc-data-types">Data types</a></li>
  <li><a href="#nulls" id="toc-nulls">NULLS</a></li>
  <li><a href="#aliasing" id="toc-aliasing">Aliasing</a></li>
  <li><a href="#converting-data-types" id="toc-converting-data-types">Converting Data Types</a></li>
  <li><a href="#extracting" id="toc-extracting">Extracting</a></li>
  <li><a href="#sec-aggregate" id="toc-sec-aggregate">Aggregate Functions</a>
  <ul>
  <li><a href="#percentiles" id="toc-percentiles">Percentiles</a></li>
  </ul></li>
  <li><a href="#merging" id="toc-merging">Merging</a></li>
  <li><a href="#window-functions" id="toc-window-functions">Window Functions</a>
  <ul>
  <li><a href="#bounding-window-functions" id="toc-bounding-window-functions">Bounding window functions</a></li>
  </ul></li>
  <li><a href="#conditionals" id="toc-conditionals">Conditionals</a></li>
  <li><a href="#dates" id="toc-dates">Dates</a></li>
  <li><a href="#sec-cte" id="toc-sec-cte">Common Table Expressions</a></li>
  <li><a href="#subqueries" id="toc-subqueries">Subqueries</a>
  <ul>
  <li><a href="#subquery-joins" id="toc-subquery-joins">Subquery Joins</a></li>
  </ul></li>
  <li><a href="#sec-text" id="toc-sec-text">Text</a></li>
  <li><a href="#random-sample" id="toc-random-sample">Random Sample</a></li>
  <li><a href="#summary-statistics" id="toc-summary-statistics">Summary Statistics</a></li>
  <li><a href="#execution-order" id="toc-execution-order">Execution Order</a>
  <ul>
  <li><a href="#more-efficient-code" id="toc-more-efficient-code">More Efficient Code</a></li>
  </ul></li>
  </ul>
</nav>
<section id="preliminaries" class="level2">
<h2>Preliminaries</h2>
<p>First we’re going to create a few datasets using r. The majority of the tutorial doesn’t use them because the combination of SQL and Quarto is a bit buggy but it’s a useful exercise anyway.</p>
<div class="cell" data-hash="SQL-published-version_cache/html/intro_cb13e0fa5e33e776998ee1a6b3b41be9">
<div class="sourceCode" id="cb1"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(odbc)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DBI)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RSQLite)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>here<span class="sc">::</span><span class="fu">i_am</span>(<span class="st">&quot;SQL-published-version.qmd&quot;</span>)</span></code></pre></div>
</div>
<div class="cell" data-hash="SQL-published-version_cache/html/create data_3bc258576e930e6a7b5a32ee059e5ec7">
<div class="sourceCode" id="cb2"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>sample_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">x2 =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="dv">10</span>, <span class="dv">15</span>),</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="dv">3</span> <span class="sc">*</span> x1 <span class="sc">+</span> <span class="dv">4</span> <span class="sc">*</span> x2 <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">g =</span> <span class="fu">rbinom</span>(<span class="dv">1000</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> <span class="fl">0.3</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>sample_data2 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">x3 =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="dv">15</span>, <span class="dv">30</span>),</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">x4 =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="dv">20</span>, <span class="dv">5</span>),</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">y2 =</span> <span class="dv">10</span> <span class="sc">*</span> x3 <span class="sc">+</span> <span class="dv">40</span> <span class="sc">*</span> x4 <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="dv">0</span>, <span class="dv">40</span>),</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">g2 =</span> <span class="fu">rbinom</span>(<span class="dv">1000</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> <span class="fl">0.3</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>mydb <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(RSQLite<span class="sc">::</span><span class="fu">SQLite</span>(), <span class="st">&quot;sample.sqlite&quot;</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="fu">dbWriteTable</span>(<span class="at">conn =</span> mydb, <span class="at">name =</span> <span class="st">&quot;sample&quot;</span>, <span class="at">value =</span> sample_data, <span class="at">overwrite =</span> T)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="fu">dbWriteTable</span>(<span class="at">conn =</span> mydb, <span class="at">name =</span> <span class="st">&quot;other_sample&quot;</span>, <span class="at">value =</span> sample_data2, <span class="at">overwrite =</span> T)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="do">#### Try to load in postgresql - doesn&#39;t currently work</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co"># https://caltechlibrary.github.io/data-carpentry-R-ecology-lesson/05-r-and-databases.html</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="co"># https://jtr13.github.io/cc21fall2/how-to-integrate-r-with-postgresql.html</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="co"># https://solutions.posit.co/connections/db/databases/postgresql/</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co">#https://medium.com/geekculture/a-simple-guide-on-connecting-rstudio-to-a-postgresql-database-9e35ccdc08be</span></span></code></pre></div>
</div>
<div class="cell" data-hash="SQL-published-version_cache/html/connect to sql_972de54dc15ef6279156791444965c1d">
<div class="sourceCode" id="cb3"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>mydb <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(RSQLite<span class="sc">::</span><span class="fu">SQLite</span>(), <span class="st">&quot;sample.sqlite&quot;</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dbListTables</span>(mydb) <span class="co"># returns a list of tables in your database</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] &quot;other_sample&quot; &quot;sample&quot;      </code></pre>
</div>
</div>
</section>
<section id="basic-syntax" class="level2">
<h2>Basic Syntax</h2>
<p>The basic syntax is you <code>SELECT</code> variables <code>FROM</code> a database.</p>
<p><span class="math display">\[\underbrace{\text{SELECT }}_{\text{Select vars}} \underbrace{\text{*}}_{\text{* is all variables}}\]</span></p>
<p><span class="math display">\[\underbrace{\text{FROM }}_{\text{from where}} \underbrace{\text{db\_name}}_{\text{name}}\]</span></p>
<p>See e.g.,</p>
<div class="cell" data-hash="SQL-published-version_cache/html/basic-sql_e716fb74623e6a101829eb3b567d8b13">
<div class="sourceCode" id="cb5"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="co">----- select all </span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="kw">sample</span> <span class="co">----- select from this dataframe</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">10</span> <span class="co">----- for demo purposes, limit output to 10 rows</span></span></code></pre></div>
</div>
<p>You can run these commands in r using the following syntax. Since you can’t run the sql commands in quarto without compiling, I’ve used this method to check that my sql commands actually work.</p>
<div class="cell" data-hash="SQL-published-version_cache/html/r-to-sql_d63770b88792aa3af8b0d53505abb85b">
<div class="sourceCode" id="cb6"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>mydb <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(RSQLite<span class="sc">::</span><span class="fu">SQLite</span>(), <span class="st">&quot;sample.sqlite&quot;</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dbGetQuery</span>(mydb,<span class="st">&#39;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="st">  select *</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="st">  from &quot;sample&quot;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="st">  limit 10</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   id         x1          x2           y g
1   1  0.2294868  14.3156629  74.7362982 0
2   2  0.6851657  14.1110263  73.5693131 0
3   3 -0.5247317 -12.8748044 -40.5904988 1
4   4  0.3784018   7.0292202  27.0929951 0
5   5 -0.8718342  -0.3591293   1.6870891 0
6   6 -0.2286860  10.9886896  39.6442041 0
7   7  0.3249191   2.3494209  23.1583781 0
8   8 -1.0748827   2.5263681   0.5947356 0
9   9  1.0472492  22.1233829 110.3033277 1
10 10 -1.4071715   2.2942946  14.5204852 0</code></pre>
</div>
</div>
<p>This can be modified (obviously!). Suppose you need two variables, <code>x1</code> and <code>x2</code>.</p>
<div class="cell" data-hash="SQL-published-version_cache/html/unnamed-chunk-1_21ee20cdcf3c1c15e1cc06b2551a874b">
<div class="sourceCode" id="cb8"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> x1, x2</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="kw">sample</span></span></code></pre></div>
</div>
<p>Here’s a more advanced query where we select rows where <code>var_1</code> <span class="math inline">\(&gt; 10\)</span></p>
<div class="cell" data-hash="SQL-published-version_cache/html/unnamed-chunk-2_65ad0664fe9945345b642ff16b13c1ce">
<div class="sourceCode" id="cb9"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> x1, x2</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="kw">sample</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> x2 <span class="op">&gt;=</span> <span class="dv">10</span></span></code></pre></div>
</div>
<div class="cell" data-hash="SQL-published-version_cache/html/see above query_03ff3073d9ce7ff247410679a5d1fa07">
<div class="sourceCode" id="cb10"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>mydb <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(RSQLite<span class="sc">::</span><span class="fu">SQLite</span>(), <span class="st">&quot;sample.sqlite&quot;</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dbGetQuery</span>(mydb,<span class="st">&#39;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="st">  select &quot;x1&quot;,&quot;x2&quot;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="st">  from &quot;sample&quot;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="st">  limit 10</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;</span>)</span></code></pre></div>
</div>
<p>Often you need summaries or operations by group. This is easy, just add the <code>GROUP BY</code> clause. Additionally you can perform an operation on the groups themselves using <code>HAVING</code>. Below, for example, we take the average of variable 1 by group having var2 &gt; 2</p>
<div class="cell" data-hash="SQL-published-version_cache/html/unnamed-chunk-3_19955056b6dee38c88a8056f81a00380">
<div class="sourceCode" id="cb11"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">avg</span>(var1)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> db_name</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> group_var</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="kw">HAVING</span> var2 <span class="op">&gt;</span> <span class="dv">0</span></span></code></pre></div>
</div>
<div class="cell" data-hash="SQL-published-version_cache/html/unnamed-chunk-4_9b9f29c3fbfb1f5f2fb4621bd9ccda53">
<div class="sourceCode" id="cb12"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>mydb <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(RSQLite<span class="sc">::</span><span class="fu">SQLite</span>(), <span class="st">&quot;sample.sqlite&quot;</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dbGetQuery</span>(mydb,<span class="st">&#39;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="st">  select avg(&quot;x1&quot;)</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="st">  from &quot;sample&quot;</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="st">  group by &quot;g&quot;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="st">  having x2 &gt;= 0</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   avg(&quot;x1&quot;)
1 0.06403565</code></pre>
</div>
</div>
<p>What is the difference? <code>HAVING</code> applies to groups as a whole whereas <code>WHERE</code> applies to individual rows. If you have both, the <code>WHERE</code> clause is applied first, the <code>GROUP BY</code> clause is second - so only the individual rows that meet the <code>WHERE</code> clause are grouped. The <code>HAVING</code> clause is then applied to the output. Then only the groups that meet the <code>HAVING</code> condition will appear.</p>
<p>Suppose you need both:</p>
<div class="cell" data-hash="SQL-published-version_cache/html/having-eg_a7503cbb46958c9f7afadd510f518187">
<div class="sourceCode" id="cb14"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">AVG</span>(var_3)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> db_name</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> var1 <span class="op">&gt;=</span> <span class="dv">10</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> group_var</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="kw">HAVING</span> var_2 <span class="op">&gt;</span> <span class="dv">5</span></span></code></pre></div>
</div>
<p>Above you’ll get the average of variable 3 from <span class="math inline">\(db\_name\)</span> only for the individual rows where <span class="math inline">\(var\_1\)</span> is greater than 10 grouped by group_var where, within the groups their associated <span class="math inline">\(var\_2\)</span> value is greater than 5.</p>
<div class="cell" data-hash="SQL-published-version_cache/html/unnamed-chunk-5_0018fed6e7e3895149094b812be40693">
<div class="sourceCode" id="cb15"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>mydb <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(RSQLite<span class="sc">::</span><span class="fu">SQLite</span>(), <span class="st">&quot;sample.sqlite&quot;</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dbGetQuery</span>(mydb,<span class="st">&#39;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="st">  select avg(&quot;y&quot;)</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="st">  from &quot;sample&quot;</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="st">  where &quot;x1&quot; &gt;= 3 </span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="st">  group by &quot;g&quot;</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="st">  having x2 &gt;= 0</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  avg(&quot;y&quot;)
1 59.87953</code></pre>
</div>
</div>
</section>
<section id="data-types" class="level2">
<h2>Data types</h2>
<p>Here are a few common data types. For a full list go to <a href="https://www.postgresql.org/docs/current/datatype.html" class="uri">https://www.postgresql.org/docs/current/datatype.html</a>.</p>
<table class="table-striped table-hover">
<caption>Data Types</caption>
<thead>
<tr class="header">
<th>Data Type</th>
<th>What does it do?</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>int</td>
<td>signed four-byte integer</td>
</tr>
<tr class="even">
<td>numeric</td>
<td>exact number. use when dealing with money</td>
</tr>
<tr class="odd">
<td>varchar</td>
<td>variable-length character string</td>
</tr>
<tr class="even">
<td>time</td>
<td>time of day (no time zone)</td>
</tr>
<tr class="odd">
<td>timestamp</td>
<td>date and time (no time zone)</td>
</tr>
<tr class="even">
<td>date</td>
<td>calendar date (year, month, day)</td>
</tr>
</tbody>
</table>
<p>For a technical discussion of the difference between float4 and float8 see this post: <a href="https://stackoverflow.com/questions/16889042/postgresql-what-is-the-difference-between-float1-and-float24" class="uri">https://stackoverflow.com/questions/16889042/postgresql-what-is-the-difference-between-float1-and-float24</a>.</p>
</section>
<section id="nulls" class="level2">
<h2>NULLS</h2>
<p>Use <code>IS NOT NULL</code> to get rid of nulls. Usually used after the <code>WHERE</code> clause.</p>
</section>
<section id="aliasing" class="level2">
<h2>Aliasing</h2>
<p>Sometimes you need to alias variables. This is especially necessary when merging as you can overwrite columns that have the same name that aren’t explicitly part of the merge.</p>
<div class="cell" data-hash="SQL-published-version_cache/html/unnamed-chunk-6_0c3a0c3052c6de39785f7ea800298fdf">
<div class="sourceCode" id="cb17"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> var <span class="kw">AS</span> new_var_name</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="op">..</span>.</span></code></pre></div>
</div>
<p>You can also alias data frames - this is useful when you have multiple data frames.</p>
<div class="cell" data-hash="SQL-published-version_cache/html/unnamed-chunk-7_884dcd5ac13e6d939de25ae696ae43f1">
<div class="sourceCode" id="cb18"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> var <span class="kw">AS</span> new_var_name</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> df1 a </span></code></pre></div>
</div>
<div class="cell" data-hash="SQL-published-version_cache/html/unnamed-chunk-8_2f610b972ff08dce8d12bb19055db2c8">
<div class="sourceCode" id="cb19"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>mydb <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(RSQLite<span class="sc">::</span><span class="fu">SQLite</span>(), <span class="st">&quot;sample.sqlite&quot;</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dbGetQuery</span>(mydb,<span class="st">&#39;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="st">  select &quot;g&quot; as &quot;group&quot;, ROUND(avg(&quot;y&quot;),2) as &quot;new_average&quot;</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="st">  from &quot;sample&quot; &quot;b&quot;</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="st">  group by &quot;g&quot;</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  group new_average
1     0       43.42
2     1       39.82</code></pre>
</div>
</div>
</section>
<section id="converting-data-types" class="level2">
<h2>Converting Data Types</h2>
<p>Sometimes the data is in one format and you need it in another. You can use <code>CAST</code> to do this</p>
<div class="cell" data-hash="SQL-published-version_cache/html/unnamed-chunk-9_4c53408f5a04e2e3c6bcd056d0f2c0bf">
<div class="sourceCode" id="cb21"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">CAST</span>(variable <span class="kw">AS</span> <span class="dt">int</span><span class="op">/</span><span class="dt">numeric</span><span class="op">/</span>varcar<span class="op">/</span><span class="dt">time</span>)</span></code></pre></div>
</div>
<p>Sometimes you need to get rid of nulls and coerce them to zeroes, to do that use <code>COALESCE</code></p>
<div class="cell" data-hash="SQL-published-version_cache/html/unnamed-chunk-10_a9ac996eeaaf1bdc20eb9030d0a897c4">
<div class="sourceCode" id="cb22"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">COALESCE</span>(variable, <span class="dv">0</span>)</span></code></pre></div>
</div>
</section>
<section id="extracting" class="level2">
<h2>Extracting</h2>
<p>A lot of times when dealing with dates you’ll need a range or only part of the information given. To extract this data, you need the command <code>extract</code>.</p>
<p>This extracts a year from a date:</p>
<div class="cell" data-hash="SQL-published-version_cache/html/unnamed-chunk-11_98dcbbb897b5cfb347e79bf11375d3f1">
<div class="sourceCode" id="cb23"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">EXTRACT</span>(<span class="dt">Year</span> <span class="kw">from</span> date_var)</span></code></pre></div>
</div>
<p>This extracts an epoch (i.e. the time difference) between the end date and the start date:</p>
<div class="cell" data-hash="SQL-published-version_cache/html/unnamed-chunk-12_35c5fb2bbe4d022a5586f9ec668e1632">
<div class="sourceCode" id="cb24"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">EXTRACT</span>(EPOCH <span class="kw">from</span> endvar<span class="op">-</span>startvar)</span></code></pre></div>
</div>
<p>Suppose, however, that you only want the days in the epoch. That’s surprisingly easy with the following code:</p>
<div class="cell" data-hash="SQL-published-version_cache/html/unnamed-chunk-13_50ef91febbe0adcb6bce378ac3f55289">
<div class="sourceCode" id="cb25"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">EXTRACT</span>(<span class="dt">Day</span> <span class="kw">from</span> endvar<span class="op">-</span>startvar)</span></code></pre></div>
</div>
</section>
<section id="sec-aggregate" class="level2">
<h2>Aggregate Functions</h2>
<p>Note that in the table below all of the functions EXCEPT count ignore null values.</p>
<table class="table-striped table-hover">
<caption>Aggregate Types</caption>
<colgroup>
<col style="width: 15%" />
<col style="width: 85%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Aggregate Fcn</th>
<th style="text-align: left;">What does it do?</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>MIN()</code></td>
<td style="text-align: left;">returns the smallest value within the selected column</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>MAX()</code></td>
<td style="text-align: left;">returns the largest value within the selected column</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>COUNT()</code></td>
<td style="text-align: left;">returns the number of rows in a set</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>SUM()</code></td>
<td style="text-align: left;">returns the total sum of a numerical column</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>AVG()</code></td>
<td style="text-align: left;">returns the <em>mean</em> value of a numerical column. Getting the median requires <code>PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY var1)</code>. See below for more info</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>GREATEST(var1, var2)</code></td>
<td style="text-align: left;">Greatest rowwise among var1 and var2</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>LEAST(var1, var2)</code></td>
<td style="text-align: left;">Least rowwise among var1 and var2</td>
</tr>
</tbody>
</table>
<p>Before we go on, a brief digression on getting the median. For reasons known only to the creators of SQL, getting the median is fantastically difficult. Suppose you want the median as a decimal rounded to the second significant digit. You’d need to write <code>ROUND(PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY var1)::DECIMAL, 2)</code>.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<p>The functions <code>MIN()</code> to <code>AVG()</code> operate globally but sometimes you need the biggest/smallest out of a single record (i.e. locally/within a row). You can do that with <code>GREATEST()</code> and <code>LEAST()</code>. Note that these also work on characters. An example will help clarify why this feature is useful.</p>
<p>Suppose you want to see the number of flights between a pair of cities (e.g. Austin and Dallas) but you don’t care about where the plane begins. In this case the command <code>CONCAT(departure_city, '-' arrival_city)</code><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> will create <strong>2</strong> separate entries for Austin-Dallas and Dallas-Austin which is not what the question asked for. So you have to use <code>GREATEST</code> and <code>LEAST</code>.</p>
<p>Greatest gets the highest alphabetically/greatest date/number out of a variable PER RECORD (i.e per row). Max gets the most <strong>OVER ALL RECORDS</strong>. Why does this difference matter? Suppose Abilene and Amarillo are in the data. Then if you used <code>MAX()</code> every row would be in the Abilene and Amarillo group.</p>
<p>Going back to our Dallas/Austin example, <code>GREATEST(departure_city, arrival_city)</code> would give us <code>Austin</code> and <code>LEAST(departure_city, arrival_city)</code> gives us <code>Dallas</code> in a row with a flight from Austin to Dallas or in a row with a flight from Dallas to Austin. In a row with a flight from Austin to London the command would give us <code>Austin</code> and <code>London</code>. So to combine these to create a unique ID, we could type <code>CONCAT(GREATEST(destination_location, source_location),'-',LEAST(destination_location, source_location))</code> and that would give us <code>Austin-Dallas</code> whenever the these two cities appeared in destination location and source location.</p>
<section id="percentiles" class="level3">
<h3>Percentiles</h3>
<p>As you could see from above, extracting the median is difficult. If you want a bunch of percentiles, the problem is even worse.</p>
<div class="cell" data-hash="SQL-published-version_cache/html/percentiles_dd905c0805cf70dbd661b5feabafa287">
<div class="sourceCode" id="cb26"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>UNNEST(<span class="dt">array</span>[<span class="dv">0</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="dv">1</span>]) <span class="kw">AS</span> percentile, </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>UNNEST(<span class="fu">PERCENTILE_CONT</span>(<span class="dt">array</span>[<span class="dv">0</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="dv">1</span>]) within <span class="kw">group</span> (<span class="kw">order</span> <span class="kw">by</span> var1)) <span class="co">---- Note that unnest wraps the whole thing!  </span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="op">..</span>.</span></code></pre></div>
</div>
<p>You have two options for calculating percentiles <code>PERCENTILE_CONT</code> and <code>PERCENTILE_DISC</code>. <code>PERCENTILE_CONT</code> will interpolate values while <code>PERCENTILE_DISC</code> will give you values only from your data. Suppose you have 2,3,4,5. PERCENTILE_CONT would give you 3.5, PERCENTILE_DISC gives you 3.</p>
</section>
</section>
<section id="merging" class="level2">
<h2>Merging</h2>
<p>There are four types of joins:</p>
<ul>
<li>INNER JOIN/JOIN
<ul>
<li>Joins all common records between tables</li>
</ul></li>
<li>LEFT JOIN
<ul>
<li>Joins the matching records in the right frame (i.e. the one after the LEFT JOIN clause) with all the records in the left frame (i.e. the one after the FROM clause)</li>
</ul></li>
<li>RIGHT JOIN
<ul>
<li>Joins all of the records in the right frame (i.e. the one after the RIGHT JOIN clause) with all the matching records in the left frame (i.e. the one after the FROM clause)</li>
</ul></li>
<li>FULL JOIN
<ul>
<li>All the records in both frames</li>
</ul></li>
</ul>
<p>These joins are all on some variable.</p>
<div class="cell" data-hash="SQL-published-version_cache/html/join_e1ceb29a944134bffa9254fcbcef1876">
<div class="sourceCode" id="cb27"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> a.var1, a.var2, a.<span class="kw">id</span>, b.var3, b.var4, b.id1 <span class="co">---- note the aliases up here.  This is good practice to show where you&#39;re getting each variable from</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> df1 a <span class="co">---- alias dataframe 1 as a</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="kw">INNER</span> <span class="kw">JOIN</span> df2 b <span class="co">----- alias dataframe 2 as b</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="kw">ON</span> a.<span class="kw">id</span> <span class="op">=</span> b.<span class="kw">id</span></span></code></pre></div>
</div>
<p>You can use <code>OR</code> in the join to join on either value. <code>AND</code> works too.</p>
<div class="cell" data-hash="SQL-published-version_cache/html/join2_02d2db392265d3f7a7bedebd5f520df7">
<div class="sourceCode" id="cb28"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> a.var1, a.var2, a.<span class="kw">id</span>, a.id2, b.var3, b.var4, b.id1, b.alt_id <span class="op">&lt;</span><span class="co">---- note the aliases up here.  This is good practice to show where you&#39;re getting each variable from</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> df1 a <span class="op">&lt;</span><span class="co">---- alias dataframe 1 as a</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="kw">INNER</span> <span class="kw">JOIN</span> df2 b <span class="op">&lt;</span><span class="co">----- alias dataframe 2 as b</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="kw">ON</span> a.<span class="kw">id</span> <span class="op">=</span> b.<span class="kw">id</span> <span class="kw">OR</span> a.var1 <span class="op">=</span> b.alt_id <span class="op">&lt;</span><span class="co">---- this joins if EITHER is true</span></span></code></pre></div>
</div>
<ul>
<li>UNION
<ul>
<li>Concatenates queries. Does not allow duplicates</li>
</ul></li>
</ul>
<div class="cell" data-hash="SQL-published-version_cache/html/union-example_e2bcb77dc64e72ea3db677a28a1404b4">
<div class="sourceCode" id="cb29"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">..</span>.</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="op">..</span>.</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="kw">UNION</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">..</span>.</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="op">..</span>.</span></code></pre></div>
</div>
<ul>
<li>UNION ALL
<ul>
<li>Concatenates queries. Allows duplicates</li>
</ul></li>
</ul>
</section>
<section id="window-functions" class="level2">
<h2>Window Functions</h2>
<p>Suppose you need to do something within a window like find all flights within 3 days. Here you need a window function. The basic syntax is as follows:</p>
<p><span class="math inline">\(\underbrace{\dots}_{\text{Some fcn}} \text{OVER} (\)</span></p>
<p><span class="math inline">\(\hspace{0.5cm}\underbrace{\text{PARTITION BY} {\color{blue}{\text{var1}}}}_{\text{group by }{\color{blue}{\text{var1}}}}\)</span></p>
<p><span class="math inline">\(\hspace{0.5cm}\underbrace{\text{ORDER BY} {\color{green}{\text{var2}}}}_{\text{order by }{\color{green}{\text{var2}}}}\)</span> <span class="math inline">\() \text{ AS newvar}\)</span></p>
<p>In addition to the functions in <a href="#sec-aggregate">Section 8</a>, here are a bunch of useful functions. For a more comprehensive list, go to <a href="https://www.postgresql.org/docs/current/functions-window.html" class="uri">https://www.postgresql.org/docs/current/functions-window.html</a></p>
<table class="table-striped table-hover">
<caption>Window Functions</caption>
<colgroup>
<col style="width: 15%" />
<col style="width: 85%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Window Function</th>
<th style="text-align: left;">What does it do?</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>lag()</code></td>
<td style="text-align: left;">lags the data 1, lag(2) would lag 2 rows</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>lead()</code></td>
<td style="text-align: left;">opposite of lag()</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>rank()</code></td>
<td style="text-align: left;">ranks rows. Suppose you have two rows tied for first, the rankings would go 1,1,3</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>dense_rank()</code></td>
<td style="text-align: left;">ranks rows without skipping.Suppose you have two rows tied for first, the rankings would go 1,1,2</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>ntile()</code></td>
<td style="text-align: left;">splits the data into n groups, indexed by an integer, as equally as possible. <code>ntile(4)</code> for example, gives us quartiles if ordered properly</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>cume_dist()</code></td>
<td style="text-align: left;">cumulative distribution</td>
</tr>
</tbody>
</table>
<section id="bounding-window-functions" class="level3">
<h3>Bounding window functions</h3>
<p>Sometimes you need to search within a certain <strong>window</strong> in a group as opposed to within an entire group. Suppose we wanted a moving average within the last three years. We could do that by properly bounding our query. The bounds come after the <code>ORDER BY</code> clause.</p>
<div class="cell" data-hash="SQL-published-version_cache/html/unnamed-chunk-14_db76f9510f92f245bfdf54835c0f94d1">
<div class="sourceCode" id="cb30"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">AVG</span>(var1) <span class="kw">OVER</span>  <span class="op">&lt;</span><span class="co">---- give us the mean of variable 1</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a> (  </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a> <span class="kw">PARTITION</span> <span class="kw">BY</span> country <span class="op">&lt;</span><span class="co">---- group by country</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a> <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">year</span> <span class="kw">desc</span> <span class="op">&lt;</span><span class="co">---- order by year descending</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a> <span class="kw">ROWS</span> <span class="kw">BETWEEN</span> <span class="dv">2</span> <span class="kw">PRECEDING</span> <span class="kw">AND</span> <span class="kw">CURRENT</span> <span class="kw">ROW</span> <span class="op">&lt;</span><span class="co">---- gives us the last 3 years.  includes the current row.</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> df1</span></code></pre></div>
</div>
<p>We can be fairly creative with the bounds using the following building blocks:</p>
<table>
<colgroup>
<col style="width: 36%" />
<col style="width: 63%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Bounds</th>
<th style="text-align: left;">What does it do?</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>n PRECEDING</code></td>
<td style="text-align: left;">2 Preceding gives us the 2 prior rows not including the current row</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>UNBOUND PRECEDING</code></td>
<td style="text-align: left;">All rows up to but not including the current row</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>CURRENT ROW</code></td>
<td style="text-align: left;">Just the current row</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>n PRECEDING AND CURRENT ROW</code></td>
<td style="text-align: left;">n preceding and the current row</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>n FOLLOWING</code></td>
<td style="text-align: left;">n following but not including the current row</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>UNBOUND FOLLOWING</code></td>
<td style="text-align: left;">n preceding and the current row</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="conditionals" class="level2">
<h2>Conditionals</h2>
<p>Sometimes you don’t just need an average, you need a conditional average or sum. This can be done with the <code>FILTER</code> command</p>
<div class="cell" data-hash="SQL-published-version_cache/html/unnamed-chunk-15_7caf026016ec233934eec8f8c2a70129">
<div class="sourceCode" id="cb31"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(var) <span class="kw">FILTER</span>(<span class="kw">WHERE</span> <span class="op">..</span>.) <span class="kw">AS</span> <span class="op">..</span>.</span></code></pre></div>
</div>
<p>You can create a new variable based on the values of other variables. You do that with <code>CASE WHEN</code></p>
<div class="cell" data-hash="SQL-published-version_cache/html/unnamed-chunk-16_f52c188dc2f0aa48e38065cf2ca13481">
<div class="sourceCode" id="cb32"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="cf">CASE</span> </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">WHEN</span> [condition] <span class="cf">THEN</span> [result]</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">WHEN</span> [condition2] <span class="cf">THEN</span> [result2]</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">ELSE</span> [result3] <span class="cf">END</span> <span class="kw">AS</span> new_conditional_variable  </span></code></pre></div>
</div>
<p>Note that the <code>CASE WHEN ...</code> can be used in the <code>GROUP BY</code> command to create groups.</p>
</section>
<section id="dates" class="level2">
<h2>Dates</h2>
<p>Dates are difficult to deal with. You just have to memorize these commands.</p>
<table class="table-striped table-hover">
<caption>Datetime Functions</caption>
<colgroup>
<col style="width: 55%" />
<col style="width: 45%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Function</th>
<th style="text-align: left;">What does it do?</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>MAKE_DATE(year,month,day)</code></td>
<td style="text-align: left;">makes dates</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>MAKE_TIMESTAMP(year,month,day, hour, minute, second)</code></td>
<td style="text-align: left;">makes timestamps</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>MAKE_INTERVAL(year,month,day, hour, minute, second)</code></td>
<td style="text-align: left;">makes intervals</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>DATE(datetime_var)</code></td>
<td style="text-align: left;">extracts dates from datetimes</td>
</tr>
</tbody>
</table>
<p>There are variations. Suppose you wanted to find all processes that lasted less than 10 days. You could use the command <code>MAKE_INTERVAL(days &lt; 10)</code></p>
</section>
<section id="sec-cte" class="level2">
<h2>Common Table Expressions</h2>
<p>Sometimes you need to create a separate table that you can then extract data from to avoid conflicts like using a window function in the <code>WHERE</code> clause. You do this with a common table expression (CTE).</p>
<p>The basic syntax is as follows:</p>
<div class="cell" data-hash="SQL-published-version_cache/html/cte-plain_20d18442a326021fdfda73bd78a663e6">
<div class="sourceCode" id="cb33"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> cte1 <span class="kw">AS</span> (</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">..</span>.</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> db1</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">..</span>.</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="op">..</span>. (likely db1 <span class="kw">or</span> db2)</span></code></pre></div>
</div>
<p>You’re not limited to one CTE, you can have multiple if you want:</p>
<div class="cell" data-hash="SQL-published-version_cache/html/ctwx2_c50514b62517cf257db90abe353533ac">
<div class="sourceCode" id="cb34"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> RECURSIVE cte1 <span class="kw">AS</span> (</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">..</span>.</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> db1</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>), <span class="co">---- need the parenthesis and comma here otherwise you get an error!</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>cte2 <span class="kw">AS</span> (</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">..</span>.</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> db2</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">..</span>.</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="op">..</span>. (likely db1 <span class="kw">or</span> db2)</span></code></pre></div>
</div>
<p>Below is an an example of using CTEs to avoid a window function in the <code>WHERE</code> clause.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> The query is from a problem that asks you to find the second longest flight between two cities. This is a bit of a tricky problem because it requires a window function, concatentaion, ordering text strings, and a common table expression.</p>
<div class="cell" data-hash="SQL-published-version_cache/html/unnamed-chunk-17_71cfa4e6245e5697be54442060746be2">
<div class="sourceCode" id="cb35"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> tmp <span class="kw">AS</span> (<span class="kw">SELECT</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="kw">id</span>, </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>destination_location,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>source_location,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>flight_start,</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>flight_end,</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="fu">dense_rank</span>() <span class="kw">OVER</span> (</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">PARTITION</span> <span class="kw">BY</span> <span class="fu">CONCAT</span>(<span class="fu">GREATEST</span>(destination_location, source_location),<span class="st">&#39;.&#39;</span>,<span class="fu">LEAST</span>(destination_location, source_location))</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="fu">extract</span>(epoch <span class="kw">from</span> flight_end <span class="op">-</span> flight_start) <span class="kw">desc</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>) <span class="kw">AS</span> flight_duration</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> flights)</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, destination_location, source_location, flight_start, flight_end</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> tmp</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a><span class="kw">where</span> flight_duration <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a><span class="kw">order</span> <span class="kw">by</span> <span class="kw">id</span></span></code></pre></div>
</div>
<p>Let’s go through this, starting with the structure. Here we’re creating a common table expression called cte and then using it</p>
<p><span class="math inline">\(\text{WITH } {\color{red}{\text{tmp}}} \text{ AS (} \leftarrow \text{Create CTE called } \color{red}{\text{tmp}}\)</span><br />
<span class="math inline">\(\hspace{1cm}\text{SELECT} \dots \leftarrow \text{Standard SQL commands in here}\)</span><br />
<span class="math inline">\(\hspace{1cm}\text{FROM} \dots\)</span><br />
<span class="math inline">\() \leftarrow \text{Close out CTE}\)</span></p>
<p><span class="math inline">\(\text{SELECT} \dots\)</span><br />
<span class="math inline">\(\text{FROM } {\color{red}{\text{tmp}}} \leftarrow \text{Use } {\color{red}{\text{tmp}}} \text{ as a normal table}\)</span></p>
<p>The other tricky bit is the window function. Here we’re using a dense rank (i.e. ranking everything sequentially so if two are tied for first the ranks are 1,1,2) by city pair (that’s the variable after partition by) ordering those groups by flight time descending.</p>
<p><span class="math inline">\(\underbrace{\text{dense_rank()}}_{\text{rank everything}} \underbrace{\text{OVER (}}_{\text{create the window}} \\ \underbrace{\text{PARTITION BY}}_{\text{select grouping var}} \hspace{0.2cm}\underbrace{\text{CONCAT(GREATEST(destination_location, source_location),&#39;.&#39;,LEAST(destination_location, source_location))}}_{\text{group by city pair}} \\ \underbrace{\text{ORDER BY}}_{\text{select order var(s)}} \hspace{0.2cm}\underbrace{\text{extract(epoch from flight_end - flight_start) desc}}_{\text{order by duration descending}} \\ ) \underbrace{\text{AS flight_duration}}_{\text{Alias this to use later}}\)</span></p>
</section>
<section id="subqueries" class="level2">
<h2>Subqueries</h2>
<p>Suppose you need a one off query within a query. You can use a sub query! The basic syntax is below. You can put them anywhere. For example, here’s one in the <code>FROM</code> clause. Note that you need to alias your subqueries or else they’ll fail</p>
<div class="cell" data-hash="SQL-published-version_cache/html/unnamed-chunk-18_9108b08f648a4cb7905e716788c0e4ab">
<div class="sourceCode" id="cb36"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">..</span>.</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> (</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> db1</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>) <span class="kw">AS</span> db2</span></code></pre></div>
</div>
<p>You could, however, do one in the <code>SELECT</code> clause if you wanted</p>
<div class="cell" data-hash="SQL-published-version_cache/html/unnamed-chunk-19_41d1529c8a31fa5ca10179bb0d7d7a3e">
<div class="sourceCode" id="cb37"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> (</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="op">..</span>.</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> <span class="op">..</span>.</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> db1</span></code></pre></div>
</div>
<p>So when to use common table expressions versus subtables? Common table expressions are, generally, preferred because they’re more readable and can be used multiple times. See, e.g., below, where we have the same query as <a href="#sec-cte">Section 13</a> but with a subquery instead of a common table expression.</p>
<div class="cell" data-hash="SQL-published-version_cache/html/unnamed-chunk-20_17133e6632cf6b4173384eea7bc94c09">
<div class="sourceCode" id="cb38"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="kw">id</span>, </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>destination_location,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>source_location,</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>flight_start,</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>flight_end</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> ( <span class="co">----- create a subquery that has everything in the initial dataframe AND a rank</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span>  <span class="co">---- (ctd) column that we can use in a where clause because the subquery </span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>,   <span class="co">----- separates the window function from the where so you can just call the </span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="fu">dense_rank</span>() <span class="kw">OVER</span> ( <span class="co">---- duration rank column as usual</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">PARTITION</span> <span class="kw">BY</span> <span class="fu">CONCAT</span>(<span class="fu">GREATEST</span>(destination_location, source_location),<span class="st">&#39;.&#39;</span>,<span class="fu">LEAST</span>(destination_location, source_location))</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="fu">extract</span>(epoch <span class="kw">from</span> flight_end <span class="op">-</span> flight_start) <span class="kw">desc</span>) <span class="kw">AS</span> duration_rank</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> flights</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    ) <span class="kw">AS</span> subquery</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> duration_rank <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a><span class="kw">order</span> <span class="kw">by</span> <span class="kw">id</span></span></code></pre></div>
</div>
<section id="subquery-joins" class="level3">
<h3>Subquery Joins</h3>
<p>Sometimes you need to do something to a database before joining it. Here a subquery join is helpful</p>
<div class="cell" data-hash="SQL-published-version_cache/html/sub-q-join_4a7a6a85c40ddccffd1fda1fb5ae0caa">
<div class="sourceCode" id="cb39"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> user_id, var1, var2 </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span>  db1</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> </span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    ( <span class="co">---- begin subquery </span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">SELECT</span> <span class="kw">id</span>, var3, var4</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">FROM</span> db2</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">WHERE</span> <span class="op">..</span>. <span class="co">-----  you&#39;re using a subquery because you need to do something so I&#39;ve included the where in here </span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="kw">AS</span> a <span class="co">--- end and alias subquery </span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="kw">ON</span> db1.user_id <span class="op">=</span> a.<span class="kw">id</span> <span class="co">---- join on subquery name!</span></span></code></pre></div>
</div>
</section>
</section>
<section id="sec-text" class="level2">
<h2>Text</h2>
<p>Sometimes you’re faced with a task where you have to concatenate (i.e. join) or split variables. I’ve seen this problem when trying to match pairs of cities for flights when the question only cares about the pair and not the ordering.</p>
<p><span class="math inline">\(\text{CONCAT(var1, var2)}\)</span></p>
<p>If you need visual separation between the values, you can always do something like:</p>
<p><span class="math inline">\(\text{CONCAT(var1, &#39;-&#39;, var2)}\)</span></p>
<p>To undo a split column, use the <code>split_part</code> clause. Be careful here because you need to specify which part of the split you want to take!</p>
<p><span class="math inline">\(\underbrace{\text{SPLIT\_PART}}_{\text{split apart}}(\underbrace{{\color{red}{\text{var}}, {\color{blue}{\text{&#39;.&#39;}}}, {\color{green}{\text{1}}}}}_{\text{split apart}{\color{red}{\text{ var}}} \text{ on}{\color{blue}{\text{ a period}}} \text{ taking }{\color{green}{\text{the first instance}}} })\)</span></p>
</section>
<section id="random-sample" class="level2">
<h2>Random Sample</h2>
<p>The method below selects 10% of the data.</p>
<div class="cell" data-hash="SQL-published-version_cache/html/random-sample_6ddf9814b7374c4e0a746fbae442f3bf">
<div class="sourceCode" id="cb40"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">..</span>.</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="op">..</span>.</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>TABLESAMPLE BERNOULLI(<span class="dv">10</span>) <span class="co">--- this is a faster way of sampling</span></span></code></pre></div>
</div>
</section>
<section id="summary-statistics" class="level2">
<h2>Summary Statistics</h2>
<p>Getting summary statistics is a pain the ass. So here is some code that will do it for a variable called <span class="math inline">\(a\)</span> in database <span class="math inline">\(t1\)</span>. The difficulty of the code is that it requires two separate common table expressions. Here’s a sketch of what that looks like. Note that adding RECURSIVE to the with query allows you to select from db1 in the db2 query.</p>
<div class="cell" data-hash="SQL-published-version_cache/html/show-cte-x2-again_37b634aff2d9c09bf82bd0f1450f6efc">
<div class="sourceCode" id="cb41"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> RECURSIVE cte1 <span class="kw">AS</span> (</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">..</span>.</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> db1</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>),</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>cte2 <span class="kw">AS</span> (</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">..</span>.</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> db2</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">..</span>.</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="op">..</span>. (likely db1 <span class="kw">or</span> db2)</span></code></pre></div>
</div>
<div class="cell" data-hash="SQL-published-version_cache/html/summary-stats_836d1c7d1c3aef101e42dda720c9f7e2">
<div class="sourceCode" id="cb42"><pre class="sourceCode sql cell-code"><code class="sourceCode sql"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> RECURSIVE</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>summary_stats <span class="kw">AS</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a> <span class="kw">SELECT</span> </span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">AVG</span>(a), <span class="dv">2</span>) <span class="kw">AS</span> mean,</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">PERCENTILE_CONT</span>(<span class="fl">0.5</span>) WITHIN <span class="kw">GROUP</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> a) <span class="kw">AS</span> <span class="fu">median</span>,</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MIN</span>(a) <span class="kw">AS</span> <span class="fu">min</span>,</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MAX</span>(a) <span class="kw">AS</span> <span class="fu">max</span>,</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MAX</span>(a) <span class="op">-</span> <span class="fu">MIN</span>(a) <span class="kw">AS</span> <span class="kw">range</span>,</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">STDDEV</span>(a), <span class="dv">2</span>) <span class="kw">AS</span> standard_deviation,</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ROUND</span>(<span class="fu">VARIANCE</span>(a), <span class="dv">2</span>) <span class="kw">AS</span> <span class="fu">variance</span>,</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">PERCENTILE_CONT</span>(<span class="fl">0.25</span>) WITHIN <span class="kw">GROUP</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> a) <span class="kw">AS</span> q1,</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">PERCENTILE_CONT</span>(<span class="fl">0.75</span>) WITHIN <span class="kw">GROUP</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> a) <span class="kw">AS</span> q3</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>   <span class="kw">FROM</span> t1</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>),</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>row_summary_stats <span class="kw">AS</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a> <span class="dv">1</span> <span class="kw">AS</span> <span class="kw">id</span>, </span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;mean&#39;</span> <span class="kw">AS</span> statistic, </span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a> mean <span class="kw">AS</span> <span class="fu">value</span> </span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> summary_stats</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a><span class="kw">union</span> <span class="kw">all</span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a> <span class="dv">2</span>, </span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;median&#39;</span>, </span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a> <span class="fu">median</span> </span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> summary_stats</span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a><span class="kw">UNION</span></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a> <span class="dv">3</span>, </span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;minimum&#39;</span>, </span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a> <span class="fu">min</span> </span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> summary_stats</span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a><span class="kw">UNION</span></span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a> <span class="dv">4</span>, </span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;maximum&#39;</span>, </span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a> <span class="fu">max</span> </span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> summary_stats</span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a><span class="kw">UNION</span></span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a> <span class="dv">5</span>, </span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;range&#39;</span>, </span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a> <span class="kw">range</span> </span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> summary_stats</span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a><span class="kw">UNION</span></span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a> <span class="dv">6</span>, </span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;standard deviation&#39;</span>, </span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a> standard_deviation </span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> summary_stats</span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true" tabindex="-1"></a><span class="kw">UNION</span></span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true" tabindex="-1"></a> <span class="dv">7</span>, </span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;variance&#39;</span>, </span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true" tabindex="-1"></a> <span class="fu">variance</span> </span>
<span id="cb42-58"><a href="#cb42-58" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> summary_stats</span>
<span id="cb42-59"><a href="#cb42-59" aria-hidden="true" tabindex="-1"></a><span class="kw">UNION</span></span>
<span id="cb42-60"><a href="#cb42-60" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb42-61"><a href="#cb42-61" aria-hidden="true" tabindex="-1"></a> <span class="dv">9</span>, </span>
<span id="cb42-62"><a href="#cb42-62" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;Q1&#39;</span>, </span>
<span id="cb42-63"><a href="#cb42-63" aria-hidden="true" tabindex="-1"></a> q1 </span>
<span id="cb42-64"><a href="#cb42-64" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> summary_stats</span>
<span id="cb42-65"><a href="#cb42-65" aria-hidden="true" tabindex="-1"></a><span class="kw">UNION</span></span>
<span id="cb42-66"><a href="#cb42-66" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb42-67"><a href="#cb42-67" aria-hidden="true" tabindex="-1"></a> <span class="dv">10</span>, </span>
<span id="cb42-68"><a href="#cb42-68" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;Q3&#39;</span>, </span>
<span id="cb42-69"><a href="#cb42-69" aria-hidden="true" tabindex="-1"></a> q3 </span>
<span id="cb42-70"><a href="#cb42-70" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> summary_stats</span>
<span id="cb42-71"><a href="#cb42-71" aria-hidden="true" tabindex="-1"></a><span class="kw">UNION</span></span>
<span id="cb42-72"><a href="#cb42-72" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb42-73"><a href="#cb42-73" aria-hidden="true" tabindex="-1"></a> <span class="dv">11</span>, </span>
<span id="cb42-74"><a href="#cb42-74" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;IQR&#39;</span>, </span>
<span id="cb42-75"><a href="#cb42-75" aria-hidden="true" tabindex="-1"></a> (q3 <span class="op">-</span> q1) </span>
<span id="cb42-76"><a href="#cb42-76" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> summary_stats</span>
<span id="cb42-77"><a href="#cb42-77" aria-hidden="true" tabindex="-1"></a><span class="kw">UNION</span></span>
<span id="cb42-78"><a href="#cb42-78" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb42-79"><a href="#cb42-79" aria-hidden="true" tabindex="-1"></a> <span class="dv">12</span>, </span>
<span id="cb42-80"><a href="#cb42-80" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;skewness&#39;</span>, </span>
<span id="cb42-81"><a href="#cb42-81" aria-hidden="true" tabindex="-1"></a> <span class="fu">ROUND</span>(<span class="dv">3</span> <span class="op">*</span> (mean <span class="op">-</span> <span class="fu">median</span>):<span class="ch">:NUMERIC</span> <span class="op">/</span> standard_deviation, <span class="dv">2</span>) <span class="kw">AS</span> skewness </span>
<span id="cb42-82"><a href="#cb42-82" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> summary_stats</span>
<span id="cb42-83"><a href="#cb42-83" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-84"><a href="#cb42-84" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> </span>
<span id="cb42-85"><a href="#cb42-85" aria-hidden="true" tabindex="-1"></a> <span class="kw">FROM</span> row_summary_stats</span>
<span id="cb42-86"><a href="#cb42-86" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="kw">id</span>;</span></code></pre></div>
</div>
</section>
<section id="execution-order" class="level2">
<h2>Execution Order</h2>
<ol type="1">
<li>JOIN
<ul>
<li>If no JOIN, then we start at FROM</li>
</ul></li>
<li>FROM</li>
<li>WHERE</li>
<li>GROUP BY</li>
<li>HAVING</li>
<li>SELECT</li>
<li>DISTINCT</li>
<li>ORDER BY</li>
<li>LIMIT/OFFSET</li>
</ol>
<section id="more-efficient-code" class="level3">
<h3>More Efficient Code</h3>
<ul>
<li><a href="https://nodeteam.medium.com/how-to-optimize-postgresql-queries-226e6ff15f72" class="uri">https://nodeteam.medium.com/how-to-optimize-postgresql-queries-226e6ff15f72</a></li>
<li>Properly index* columns used in WHERE and JOIN conditions.
<ul>
<li>Index will create a pointer to the actual rows in the specified table.</li>
<li><a href="https://www.postgresql.org/docs/current/sql-createindex.html" class="uri">https://www.postgresql.org/docs/current/sql-createindex.html</a></li>
</ul></li>
<li>Use appropriate data types and avoid unnecessary data type conversions.</li>
<li>Limit the use of SELECT * and only retrieve the columns you need.</li>
<li>Minimize the use of subqueries and consider JOIN alternatives.</li>
<li>Monitor and analyze query performance using database-specific tools and profiling.”</li>
</ul>
</section>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p>If you ask why, I’ll give you my favorite coding answer.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>See <a href="#sec-text">Section 15</a> for more details<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>See <a href="https://www.interviewquery.com/questions/second-longest-flight" class="uri">https://www.interviewquery.com/questions/second-longest-flight</a> for full problem details<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main>
<!-- /main column -->
<script id = "quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->

</body>

</html>